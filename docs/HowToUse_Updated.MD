# ğŸš— EV Service Center Backend

TÃ i liá»‡u hÆ°á»›ng dáº«n cÃ i Ä‘áº·t, cáº¥u hÃ¬nh, khá»Ÿi cháº¡y vÃ  sá»­ dá»¥ng Prisma ORM cho há»‡ thá»‘ng **Trung tÃ¢m Dá»‹ch vá»¥ Xe Ä‘iá»‡n (EV Service Center)** â€” Backend API.

---

## ğŸ§© 1. YÃªu cáº§u MÃ´i trÆ°á»ng (Prerequisites)

TrÆ°á»›c khi báº¯t Ä‘áº§u, hÃ£y Ä‘áº£m báº£o mÃ¡y cá»§a báº¡n Ä‘Ã£ cÃ i Ä‘áº·t cÃ¡c pháº§n má»m sau:

- **Node.js**: PhiÃªn báº£n **v18.x** hoáº·c má»›i hÆ¡n  
- **pnpm**: TrÃ¬nh quáº£n lÃ½ gÃ³i thay tháº¿ npm  
  ğŸ‘‰ CÃ i Ä‘áº·t báº±ng lá»‡nh:
  ```bash
  npm install -g pnpm
  ```
- **PostgreSQL**: Cáº§n cÃ³ **má»™t server PostgreSQL** Ä‘ang hoáº¡t Ä‘á»™ng

---

## âš™ï¸ 2. CÃ¡c bÆ°á»›c CÃ i Ä‘áº·t

### ğŸªœ BÆ°á»›c 2.1: Táº£i mÃ£ nguá»“n

Clone repository hoáº·c táº£i mÃ£ nguá»“n vá» mÃ¡y:

```bash
git clone <your-repository-url>
cd SWP391_EV_Maitenance_service_BackEnd
```

### ğŸ“¦ BÆ°á»›c 2.2: CÃ i Ä‘áº·t Dependencies

CÃ i Ä‘áº·t táº¥t cáº£ thÆ° viá»‡n cáº§n thiáº¿t:

```bash
pnpm install
```

---

## ğŸ” 3. Cáº¥u hÃ¬nh MÃ´i trÆ°á»ng (.env)

Táº¡o file tÃªn lÃ  `.env` trong thÆ° má»¥c gá»‘c cá»§a dá»± Ã¡n vÃ  thÃªm cÃ¡c giÃ¡ trá»‹ cáº¥u hÃ¬nh theo máº«u sau:

```bash
# 1. Cáº¥u hÃ¬nh CSDL PostgreSQL
DATABASE_URL="postgresql://postgres:mysecretpassword@localhost:5432/ev_service_db?schema=public"

# 2. JSON Web Token (JWT)
JWT_SECRET="your_super_secret_jwt_key"

# 3. Google OAuth 2.0 (Passport)
GOOGLE_CLIENT_ID="your-google-client-id.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="your-google-client-secret"

# 4. Express Session
SESSION_SECRET="your_super_secret_session_key"

# 5. Nodemailer (QuÃªn máº­t kháº©u)
EMAIL_USER="your-email@gmail.com"
EMAIL_PASS="your-gmail-app-password"
```

> ğŸ’¡ **LÆ°u Ã½:**  
> Äá»‘i vá»›i Google OAuth, báº¡n cáº§n Ä‘Äƒng kÃ½ URL sau trong pháº§n "Authorized redirect URIs" trÃªn [Google Cloud Console](https://console.cloud.google.com/):  
> ```
> http://localhost:5000/api/auth/google/callback
> ```

---

## ğŸ—„ï¸ 4. Thiáº¿t láº­p CÆ¡ sá»Ÿ Dá»¯ liá»‡u

Äá»ƒ Prisma táº¡o vÃ  Ã¡p dá»¥ng migration, hÃ£y cháº¡y:

```bash
pnpm prisma migrate dev
```

Lá»‡nh nÃ y sáº½ Ä‘á»“ng bá»™ schema trong Prisma vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u PostgreSQL cá»§a báº¡n.

---

## ğŸ“˜ 5. Thiáº¿t láº­p Swagger (TÃ i liá»‡u & Kiá»ƒm thá»­ API)

### âš™ï¸ BÆ°á»›c 5.1: CÃ i Ä‘áº·t thÆ° viá»‡n

Náº¿u chÆ°a cÃ³, cÃ i Ä‘áº·t thÃªm Swagger UI:

```bash
pnpm add swagger-ui-express yamljs
```

### ğŸš€ BÆ°á»›c 5.2: Cháº¡y á»¨ng dá»¥ng

Khá»Ÿi Ä‘á»™ng server á»Ÿ cháº¿ Ä‘á»™ phÃ¡t triá»ƒn:

```bash
pnpm dev
```

Server sáº½ cháº¡y táº¡i Ä‘á»‹a chá»‰:

```
http://localhost:6969
```

### ğŸŒ BÆ°á»›c 5.3: Truy cáº­p Swagger UI

Má»Ÿ trÃ¬nh duyá»‡t vÃ  truy cáº­p:

```
http://localhost:6969/api-docs
```

> Dá»± Ã¡n Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ tá»± Ä‘á»™ng táº£i tÃ i liá»‡u tá»« file `swagger.yaml` táº¡i thÆ° má»¥c gá»‘c.

---

## ğŸ§® 6. (TÃ¹y chá»n) Táº¡o Dá»¯ liá»‡u Máº«u

Náº¿u báº¡n muá»‘n khá»Ÿi táº¡o dá»¯ liá»‡u máº«u Ä‘á»ƒ kiá»ƒm thá»­:

```bash
pnpm db:seed
```

---

## ğŸ“š 7. Prisma ORM - HÃ m thÆ°á»ng dÃ¹ng

Prisma lÃ  ORM (Object-Relational Mapping) giÃºp giao tiáº¿p vá»›i database má»™t cÃ¡ch an toÃ n vÃ  dá»… dÃ ng.

### ğŸ“Œ Setup Prisma Client

Trong cÃ¡c file controller hoáº·c service, import Prisma Client:

```javascript
import { PrismaClient } from '@prisma/client';
// hoáº·c náº¿u Ä‘Ã£ cÃ³ file config:
import prisma from '@/generated/prisma/index.js';

const prisma = new PrismaClient();
```

---

### 1ï¸âƒ£ CREATE - Táº¡o dá»¯ liá»‡u

```javascript
// Táº¡o 1 user má»›i
const newUser = await prisma.user.create({
  data: {
    email: 'john@example.com',
    password: 'hashed_password',
    fullName: 'John Doe',
    phone: '0123456789',
    role: 'USER'
  }
});

// Táº¡o user kÃ¨m vehicle (relation)
const userWithVehicle = await prisma.user.create({
  data: {
    email: 'jane@example.com',
    password: 'hashed_password',
    fullName: 'Jane Doe',
    vehicles: {
      create: {
        licensePlate: 'ABC123',
        brand: 'Tesla',
        model: 'Model 3'
      }
    }
  },
  include: {
    vehicles: true  // Tráº£ vá» cáº£ vehicles
  }
});
```

---

### 2ï¸âƒ£ READ - Äá»c dá»¯ liá»‡u

```javascript
// Láº¥y 1 user theo ID
const user = await prisma.user.findUnique({
  where: { id: 'user-uuid-here' }
});

// Láº¥y 1 user theo email
const userByEmail = await prisma.user.findUnique({
  where: { email: 'john@example.com' }
});

// Láº¥y táº¥t cáº£ users
const allUsers = await prisma.user.findMany();

// Láº¥y users vá»›i Ä‘iá»u kiá»‡n
const activeUsers = await prisma.user.findMany({
  where: {
    isActive: true,
    role: 'USER'
  }
});

// Láº¥y vá»›i phÃ¢n trang
const paginatedUsers = await prisma.user.findMany({
  skip: 0,      // Bá» qua bao nhiÃªu báº£n ghi
  take: 10,     // Láº¥y bao nhiÃªu báº£n ghi
  orderBy: {
    createdAt: 'desc'  // Sáº¯p xáº¿p má»›i nháº¥t trÆ°á»›c
  }
});

// Láº¥y user vá»›i vehicles (relation)
const userWithVehicles = await prisma.user.findUnique({
  where: { id: 'user-id' },
  include: {
    vehicles: true,
    appointments: true
  }
});

// Láº¥y user cÃ¹ng vehicles active (Ä‘iá»u kiá»‡n lá»“ng)
const userWithActiveVehicles = await prisma.user.findUnique({
  where: { id: 'user-id' },
  include: {
    vehicles: {
      where: { isActive: true }  // Chá»‰ vehicles active
    }
  }
});

// Äáº¿m tá»•ng sá»‘ users
const userCount = await prisma.user.count();

// Äáº¿m users active
const activeCount = await prisma.user.count({
  where: { isActive: true }
});
```

---

### 3ï¸âƒ£ UPDATE - Cáº­p nháº­t dá»¯ liá»‡u

```javascript
// Cáº­p nháº­t 1 user
const updatedUser = await prisma.user.update({
  where: { id: 'user-id' },
  data: {
    fullName: 'John Updated',
    phone: '9876543210'
  }
});

// Cáº­p nháº­t nhiá»u users
const updatedCount = await prisma.user.updateMany({
  where: { role: 'GUEST' },
  data: { isActive: false }  // VÃ´ hiá»‡u táº¥t cáº£ GUEST
});

// Upsert (cáº­p nháº­t náº¿u tá»“n táº¡i, náº¿u khÃ´ng thÃ¬ táº¡o má»›i)
const user = await prisma.user.upsert({
  where: { email: 'john@example.com' },
  update: { fullName: 'John Updated' },
  create: {
    email: 'john@example.com',
    fullName: 'John Doe',
    password: 'hashed_password',
    role: 'USER'
  }
});
```

---

### 4ï¸âƒ£ DELETE - XÃ³a dá»¯ liá»‡u

```javascript
// XÃ³a 1 user
const deletedUser = await prisma.user.delete({
  where: { id: 'user-id' }
});

// XÃ³a nhiá»u users
const deletedCount = await prisma.user.deleteMany({
  where: { role: 'GUEST' }
});

// âš ï¸ XÃ³a táº¥t cáº£ (cáº©n tháº­n!)
await prisma.user.deleteMany({});
```

---

### 5ï¸âƒ£ RELATIONS - Quan há»‡ (1-to-many, many-to-many)

```javascript
// Láº¥y user + vehicles + appointments
const fullUserData = await prisma.user.findUnique({
  where: { id: 'user-id' },
  include: {
    vehicles: {
      select: {
        id: true,
        licensePlate: true,
        brand: true
      }
    },
    appointments: true
  }
});

// Láº¥y vehicle + owner user
const vehicleWithOwner = await prisma.vehicle.findUnique({
  where: { id: 'vehicle-id' },
  include: {
    user: true  // Láº¥y user sá»Ÿ há»¯u
  }
});

// Táº¡o appointment liÃªn káº¿t user, vehicle, service type
const newAppointment = await prisma.serviceAppointment.create({
  data: {
    appointmentDate: new Date('2025-12-01'),
    status: 'PENDING',
    userId: 'user-id',
    vehicleId: 'vehicle-id',
    serviceTypeId: 'service-type-id',
    description: 'Báº£o dÆ°á»¡ng Ä‘á»‹nh ká»³'
  },
  include: {
    user: true,
    vehicle: true,
    serviceType: true
  }
});
```

---

### 6ï¸âƒ£ FILTERS - CÃ¡c Ä‘iá»u kiá»‡n tÃ¬m kiáº¿m

```javascript
// NOT - KhÃ´ng báº±ng
const inactiveUsers = await prisma.user.findMany({
  where: {
    isActive: { not: true }
  }
});

// IN - Trong danh sÃ¡ch
const specificUsers = await prisma.user.findMany({
  where: {
    id: { in: ['id1', 'id2', 'id3'] }
  }
});

// CONTAINS - Chá»©a (tÃ¬m kiáº¿m)
const usersWithDoe = await prisma.user.findMany({
  where: {
    fullName: { contains: 'Doe', mode: 'insensitive' }
  }
});

// STARTSWITH / ENDSWITH
const usersWithJ = await prisma.user.findMany({
  where: {
    fullName: { startsWith: 'J' }
  }
});

// GT, GTE, LT, LTE (so sÃ¡nh)
const recentUsers = await prisma.user.findMany({
  where: {
    createdAt: { gte: new Date('2025-01-01') }  // >= 2025-01-01
  }
});

// AND, OR
const complexFilter = await prisma.user.findMany({
  where: {
    AND: [
      { isActive: true },
      { role: 'USER' }
    ]
  }
});
```

---

### 7ï¸âƒ£ AGGREGATION - Tá»•ng há»£p dá»¯ liá»‡u

```javascript
// Äáº¿m, tÃ­nh trung bÃ¬nh, min, max
const stats = await prisma.user.aggregate({
  _count: true,  // Tá»•ng sá»‘ user
  _avg: { id: true }
});

// Group by - NhÃ³m theo status
const appointmentStats = await prisma.serviceAppointment.groupBy({
  by: ['status'],
  _count: true
});
// Káº¿t quáº£: [{status: 'PENDING', _count: 5}, {status: 'COMPLETED', _count: 3}]

// Min/Max ngÃ y
const vehicleStats = await prisma.vehicle.aggregate({
  _count: true,
  _min: { createdAt: true },
  _max: { createdAt: true }
});
```

---

### 8ï¸âƒ£ TRANSACTION - Giao dá»‹ch (nhiá»u thao tÃ¡c cÃ¹ng lÃºc)

```javascript
// Táº¡o user vÃ  vehicle trong 1 transaction
try {
  const [newUser, newVehicle] = await prisma.$transaction([
    prisma.user.create({
      data: {
        email: 'test@example.com',
        fullName: 'Test User',
        password: 'hashed',
        role: 'USER'
      }
    }),
    prisma.vehicle.create({
      data: {
        licensePlate: 'XYZ789',
        brand: 'BMW',
        model: '3 Series',
        userId: 'user-id'
      }
    })
  ]);
  // Náº¿u cáº£ 2 thÃ nh cÃ´ng = commit, 1 lá»—i = rollback táº¥t
} catch (error) {
  console.error('Transaction failed:', error);
}
```

---

### 9ï¸âƒ£ RAW QUERIES - SQL trá»±c tiáº¿p

```javascript
// Chá»‰ dÃ¹ng khi Prisma khÃ´ng Ä‘á»§
const result = await prisma.$queryRaw`
  SELECT u.id, u.fullName, COUNT(v.id) as vehicleCount
  FROM "User" u
  LEFT JOIN "Vehicle" v ON u.id = v.userId
  GROUP BY u.id
`;
```

---

## ğŸ› ï¸ Lá»‡nh Prisma há»¯u Ã­ch

```bash
# Má»Ÿ Prisma Studio (GUI Ä‘á»ƒ xem/chá»‰nh sá»­a dá»¯ liá»‡u)
pnpm prisma studio

# Kiá»ƒm tra schema Prisma cÃ³ lá»—i khÃ´ng
pnpm prisma validate

# Format láº¡i file schema.prisma
pnpm prisma format

# Táº¡o migration má»›i (khÃ´ng cháº¡y)
pnpm prisma migrate create --name migration_name

# Ãp dá»¥ng pending migrations
pnpm prisma migrate deploy

# Reset database (xÃ³a táº¥t cáº£, cháº¡y láº¡i migrations)
pnpm prisma migrate reset

# Xem migration status
pnpm prisma migrate status

# Generate Prisma Client
pnpm prisma generate
```

---

## âœ… HoÃ n táº¥t

Náº¿u báº¡n Ä‘Ã£ lÃ m Ä‘Ãºng cÃ¡c bÆ°á»›c trÃªn, backend cá»§a báº¡n Ä‘Ã£ sáºµn sÃ ng hoáº¡t Ä‘á»™ng ğŸ‰  
Báº¡n cÃ³ thá»ƒ káº¿t ná»‘i frontend hoáº·c Postman Ä‘á»ƒ thá»­ cÃ¡c API Ä‘Æ°á»£c mÃ´ táº£ trong Swagger.

---

### ğŸ§  Gá»£i Ã½ thÃªm
- Kiá»ƒm tra láº¡i káº¿t ná»‘i DB náº¿u Prisma bÃ¡o lá»—i.
- Kiá»ƒm tra biáº¿n mÃ´i trÆ°á»ng `.env` Ä‘Æ°á»£c Ä‘á»‹nh dáº¡ng Ä‘Ãºng.
- DÃ¹ng `pnpm build` náº¿u cáº§n build cho mÃ´i trÆ°á»ng production.
- Tham kháº£o [Prisma Documentation](https://www.prisma.io/docs/) Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.

---

**Â© EV Service Center Project â€” 2025**
