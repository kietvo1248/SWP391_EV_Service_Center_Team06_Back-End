openapi: 3.0.0
info:
  title: EV Service Center API
  description: Tài liệu API cho hệ thống Trung tâm Dịch vụ Xe điện (Đã cải tổ Booking & Inventory).
  version: 2.0.0
servers:
  - url: http://localhost:6969/api
    description: Development server
  - url: https://swp391-restapi-ev-service-center-back-ckkz.onrender.com/api
    description: Production server
tags:
  - name: '[0] Xác thực & Hồ sơ (Chung)'
    description: Đăng ký, đăng nhập, quản lý hồ sơ cá nhân, quên mật khẩu.
  - name: '[V] Quản lý Xe (Vehicle)'
    description: Quản lý CRUD (Tạo, Xem, Sửa, Xóa) xe của khách hàng.
  - name: '[1] Luồng Khách hàng (Customer)'
    description: Kịch bản khách hàng tự đặt lịch (chọn gói) trực tuyến và theo dõi.
  - name: '[2] Luồng Nhân viên (Staff)'
    description: Kịch bản nhân viên tại quầy (check-in, tạo lịch walk-in, tạo hóa đơn).
  - name: '[3] Luồng Kỹ thuật viên (Technician)'
    description: Kịch bản kỹ thuật viên nhận việc, xem kho, sử dụng phụ tùng và hoàn thành.
  - name: '[4] Luồng Quản lý Kho (Inventory)'
    description: Kịch bản dành cho INVENTORY MANAGER (Kiểm kê, Yêu cầu nhập, Nhập hàng vào kho).
  - name: '[5] Luồng Quản trị viên (Admin)'
    description: Kịch bản quản trị viên (Admin) tạo tài khoản Station Admin.
  - name: '[6] Luồng Quản lý Trạm (Station)'
    description: Kịch bản dành cho STATION ADMIN (Quản lý nhân sự, Phê duyệt yêu cầu nhập hàng).
security:
  - bearerAuth: []
paths:
  # ===============================================
  # === [0] XÁC THỰC & HỒ SƠ (CHUNG)
  # ===============================================
  /auth/register:
    post:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: Đăng ký tài khoản Customer
      security: []
      requestBody: { $ref: '#/components/requestBodies/RegisterInput' }
      responses:
        '201': { description: Đăng ký thành công., content: { application/json: { schema: { $ref: '#/components/schemas/User' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
  /auth/login:
    post:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: Đăng nhập (Email/Password)
      security: []
      requestBody: { $ref: '#/components/requestBodies/LoginInput' }
      responses:
        '200': { description: Đăng nhập thành công., content: { application/json: { schema: { $ref: '#/components/schemas/LoginResponse' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
  /auth/google:
    get:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: Bắt đầu đăng nhập với Google
      security: []
      responses:
        '302': { description: Redirect đến Google. }
  /auth/google/callback:
    get:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: Callback sau khi Google xác thực
      security: []
      responses:
        '302': { description: Chuyển hướng (Redirect) trở lại Frontend với token (ví dụ: /login-success?token=...) }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /auth/forgot-password:
    post:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: Yêu cầu mã đặt lại mật khẩu
      security: []
      requestBody: { $ref: '#/components/requestBodies/ForgotPasswordInput' }
      responses:
        '200': { description: Gửi mã thành công., content: { application/json: { schema: { properties: { message: { type: string } } } } } }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /auth/verify-reset-code:
    post:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: Xác thực mã đặt lại mật khẩu
      security: []
      requestBody: { $ref: '#/components/requestBodies/VerifyCodeInput' }
      responses:
        '200': { description: Mã hợp lệ, trả về resetToken., content: { application/json: { schema: { properties: { message: { type: string }, resetToken: { type: string } } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
  /auth/reset-password:
    post:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: Đặt lại mật khẩu mới
      security: []
      parameters: [{ $ref: '#/components/parameters/ResetTokenHeader' }]
      requestBody: { $ref: '#/components/requestBodies/ResetPasswordInput' }
      responses:
        '200': { description: Mật khẩu đã được đặt lại., content: { application/json: { schema: { properties: { message: { type: string } } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /auth/profile:
    get:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: (Profile) Lấy thông tin cá nhân (My Profile)
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { $ref: '#/components/schemas/User' } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /auth/update-profile:
    put:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: (Profile) Cập nhật thông tin cá nhân
      requestBody: { $ref: '#/components/requestBodies/UpdateProfileInput' }
      responses:
        '200': { description: Cập nhật thành công., content: { application/json: { schema: { $ref: '#/components/schemas/User' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /auth/change-password:
    post:
      tags: ['[0] Xác thực & Hồ sơ (Chung)']
      summary: (Profile) Đổi mật khẩu
      requestBody: { $ref: '#/components/requestBodies/ChangePasswordInput' }
      responses:
        '200': { description: Đổi mật khẩu thành công., content: { application/json: { schema: { properties: { message: { type: string } } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  # ===============================================
  # === [V] QUẢN LÝ XE (VEHICLE)
  # ===============================================
  /vehicle/models:
    get:
      tags: ['[V] Quản lý Xe (Vehicle)']
      summary: (Hỗ trợ) Lấy danh sách Dòng xe
      responses:
        '200': { description: Danh sách dòng xe., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/VehicleModel' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /vehicle/models/{modelId}/batteries:
    get:
      tags: ['[V] Quản lý Xe (Vehicle)']
      summary: (Hỗ trợ) Lấy danh sách Pin tương thích
      parameters:
        - { $ref: '#/components/parameters/VehicleModelIdPath' }
      responses:
        '200': { description: Danh sách các loại pin., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/BatteryType' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /vehicle/add-vehicle:
    post:
      tags: ['[V] Quản lý Xe (Vehicle)']
      summary: (CRUD) Thêm một xe mới
      description: Roles: CUSTOMER, STAFF
      requestBody: { $ref: '#/components/requestBodies/CreateVehicleInput' }
      responses:
        '201': { description: Thêm xe thành công., content: { application/json: { schema: { $ref: '#/components/schemas/Vehicle' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /vehicle/my-vehicles:
    get:
      tags: ['[V] Quản lý Xe (Vehicle)']
      summary: (CRUD) Lấy danh sách xe của tôi
      description: Roles: CUSTOMER
      responses:
        '200': { description: Danh sách xe (chưa xóa) của khách hàng., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/Vehicle' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /vehicle/vehicle-details/{id}:
    get:
      tags: ['[V] Quản lý Xe (Vehicle)']
      summary: (CRUD) Lấy chi tiết một xe
      description: Roles: CUSTOMER
      parameters:
        - { $ref: '#/components/parameters/VehicleIdPath' }
      responses:
        '200': { description: Chi tiết xe., content: { application/json: { schema: { $ref: '#/components/schemas/Vehicle' } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /vehicle/update-vehicle/{id}:
    put:
      tags: ['[V] Quản lý Xe (Vehicle)']
      summary: (CRUD) Cập nhật thông tin xe
      description: Cập nhật các trường được phép (Biển số, Màu, Loại Pin, Số Km). Roles: CUSTOMER
      parameters:
        - { $ref: '#/components/parameters/VehicleIdPath' }
      requestBody: { $ref: '#/components/requestBodies/UpdateVehicleInput' }
      responses:
        '200': { description: Cập nhật thành công., content: { application/json: { schema: { $ref: '#/components/schemas/Vehicle' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /vehicle/delete-vehicle/{id}:
    delete:
      tags: ['[V] Quản lý Xe (Vehicle)']
      summary: (CRUD) Xóa (xóa mềm) một xe
      description: Roles: CUSTOMER
      parameters:
        - { $ref: '#/components/parameters/VehicleIdPath' }
      responses:
        '204': { description: Xóa thành công. }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  # ===============================================
  # === [1] LUỒNG KHÁCH HÀNG (CUSTOMER)
  # ===============================================
  /appointments/my-vehicles:
    get:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.2) Lấy danh sách xe của tôi (Để chọn đặt lịch)'
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/Vehicle' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /appointments/service-types:
    get:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.3) Lấy danh sách Gói dịch vụ (Để chọn đặt lịch)'
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/ServiceType' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /appointments/suggestions:
    get:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.3b) Lấy gợi ý Gói dịch vụ (Theo xe đã lưu)'
      description: Cung cấp ID của xe, hệ thống sẽ tự lấy số km và dòng xe đã lưu để đưa ra gợi ý.
      parameters:
        - name: vehicleId
          in: query
          required: true
          schema: { type: string, format: uuid }
          description: "ID của xe (lấy từ /api/vehicle/my-vehicles)"
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/ServiceType' } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /service-centers:
    get:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.4) Lấy danh sách trung tâm dịch vụ'
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/ServiceCenter' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /service-centers/{id}/available-slots:
    get:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.5) Lấy các khung giờ trống theo ngày (Để chọn đặt lịch)'
      parameters:
        - { $ref: '#/components/parameters/ServiceCenterIdPath' }
        - { $ref: '#/components/parameters/DateQuery' }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/AvailableSlot' } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /appointments/create-appointment:
    post:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.6) Xác nhận & Tạo lịch hẹn mới'
      requestBody: { $ref: '#/components/requestBodies/AppointmentInput' }
      responses:
        '201': { description: Tạo lịch hẹn thành công (Trạng thái PENDING)., content: { application/json: { schema: { $ref: '#/components/schemas/ServiceAppointment' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /appointments/{id}:
    get:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.7) Xem chi tiết lịch hẹn'
      parameters: [{ $ref: '#/components/parameters/AppointmentIdPath' }]
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { $ref: '#/components/schemas/AppointmentDetailSharedView' } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /appointments/history:
    get:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.9) Lấy lịch sử lịch hẹn'
      description: Lấy danh sách các lịch hẹn đã COMPLETED hoặc CANCELLED.
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/AppointmentHistoryView' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /appointments/{id}/cancel:
    put:
      tags: ['[1] Luồng Khách hàng (Customer)']
      summary: '(L1.10) [Khách hàng] Hủy lịch hẹn'
      description: Khách hàng chỉ có thể hủy lịch hẹn ở trạng thái PENDING hoặc CONFIRMED.
      parameters: [{ $ref: '#/components/parameters/AppointmentIdPath' }]
      responses:
        '200': { description: Lịch hẹn đã được hủy thành công., content: { application/json: { schema: { $ref: '#/components/schemas/ServiceAppointment' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  # ===============================================
  # === [2] LUỒNG NHÂN VIÊN (STAFF)
  # ===============================================
  /staff/appointments:
    get:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L1) Xem danh sách lịch hẹn tại trung tâm'
      parameters:
        - name: status
          in: query
          required: false
          schema: { $ref: '#/components/schemas/AppointmentStatusEnum' }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/AppointmentSummaryStaffView' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /staff/appointments/{id}:
    get:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: (Chung) [Nhân viên] Lấy chi tiết một lịch hẹn
      description: API nội bộ cho nhân viên (Staff, SA, Admin) xem chi tiết lịch hẹn.
      parameters: [{ $ref: '#/components/parameters/AppointmentIdPath' }]
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { $ref: '#/components/schemas/AppointmentDetailSharedView' } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /staff/technicians:
    get:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L1 & L2) Lấy danh sách kỹ thuật viên (Để phân công)'
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/TechnicianInfo' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /staff/appointments/{id}/confirm:
    put:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L1) Xác nhận & Phân công lịch hẹn (PENDING -> CONFIRMED)'
      parameters: [{ $ref: '#/components/parameters/AppointmentIdPath' }]
      requestBody: { $ref: '#/components/requestBodies/ConfirmAppointmentInput' }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { properties: { message: { type: string }, data: { properties: { updatedAppointment: { $ref: '#/components/schemas/ServiceAppointment' }, newServiceRecord: { $ref: '#/components/schemas/ServiceRecord' } } } } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /staff/appointments/search:
    get:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L1) Tìm lịch hẹn (CONFIRMED) theo SĐT (Để Check-in)'
      parameters:
        - { name: phone, in: query, required: true, description: SĐT khách, schema: { type: string } }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/AppointmentSummaryStaffView' } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /staff/appointments/{id}/start:
    put:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L1) Bắt đầu dịch vụ (Check-in xe) (CONFIRMED -> IN_PROGRESS)'
      description: Chỉ chuyển trạng thái Appointment, KTV phải nhấn "Accept Task" để bắt đầu ServiceRecord.
      parameters: [{ $ref: '#/components/parameters/AppointmentIdPath' }]
      requestBody:
        description: (Tùy chọn) Cập nhật số km mới nhất của xe khi check-in.
        content:
          application/json:
            schema:
              type: object
              properties:
                currentMileage:
                  type: integer
                  example: 25000
                  description: "Số km (Odometer) mới nhất của xe."
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { properties: { message: { type: string }, data: { properties: { updatedAppointment: { $ref: '#/components/schemas/ServiceAppointment' } } } } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /staff/appointments/{id}/cancel:
    put:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L1/L2) [Nhân viên] Hủy lịch hẹn'
      description: Nhân viên hủy lịch hẹn (do khách gọi điện, hoặc lý do nghiệp vụ).
      parameters: [{ $ref: '#/components/parameters/AppointmentIdPath' }]
      responses:
        '200': { description: Lịch hẹn đã được hủy thành công., content: { application/json: { schema: { $ref: '#/components/schemas/ServiceAppointment' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /staff/customers/search:
    get:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L2.1) [Walk-in] Tìm khách hàng theo SĐT'
      parameters:
        - { name: phone, in: query, required: true, schema: { type: string } }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/User' } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
  /staff/customers/create:
    post:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L2.2) [Walk-in] Tạo khách hàng mới (Nếu không tìm thấy)'
      requestBody: { $ref: '#/components/requestBodies/CreateCustomerInput' }
      responses:
        '201': { description: Tạo khách hàng thành công., content: { application/json: { schema: { $ref: '#/components/schemas/CreateAccountResponse' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
  /staff/customers/{customerId}/vehicles:
    get:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L2.3a) [Walk-in] Lấy danh sách xe của khách'
      parameters: [{ $ref: '#/components/parameters/CustomerIdPath' }]
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/Vehicle' } } } } }
    post:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L2.3b) [Walk-in] Thêm xe mới cho khách'
      description: API này nên dùng /api/vehicle/add-vehicle (đã được phân quyền cho STAFF)
      parameters: [{ $ref: '#/components/parameters/CustomerIdPath' }]
      requestBody: { $ref: '#/components/requestBodies/CreateVehicleInput' }
      responses:
        '201': { description: Thêm xe thành công., content: { application/json: { schema: { $ref: '#/components/schemas/Vehicle' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
  /staff/appointments/create-walk-in:
    post:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L2.4) [Walk-in] Tạo và Bắt đầu lịch hẹn ngay (-> IN_PROGRESS)'
      requestBody: { $ref: '#/components/requestBodies/WalkInAppointmentInput' }
      responses:
        '201': { description: Tạo và bắt đầu lịch hẹn thành công., content: { application/json: { schema: { properties: { message: { type: string }, data: { properties: { appointment: { $ref: '#/components/schemas/ServiceAppointment' }, serviceRecord: { $ref: '#/components/schemas/ServiceRecord' } } } } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
  /staff/service-records/{id}/create-invoice:
    post:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L1/L2) Tạo hóa đơn (Khi KTV đã COMPLETED)'
      parameters: [{ $ref: '#/components/parameters/ServiceRecordIdPath' }]
      responses:
        '201': { description: Tạo hóa đơn thành công., content: { application/json: { schema: { $ref: '#/components/schemas/Invoice' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /staff/invoices/{id}/pay-cash:
    post:
      tags: ['[2] Luồng Nhân viên (Staff)']
      summary: '(L1/L2) Ghi nhận thanh toán tiền mặt (UNPAID -> PAID)'
      parameters: [{ $ref: '#/components/parameters/InvoiceIdPath' }]
      responses:
        '200': { description: Ghi nhận thành công., content: { application/json: { schema: { properties: { message: { type: string }, invoice: { $ref: '#/components/schemas/Invoice' } } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  # ===============================================
  # === [3] LUỒNG KỸ THUẬT VIÊN (TECHNICIAN)
  # ===============================================
  /technician/inventory:
    get:
      tags: ['[3] Luồng Kỹ thuật viên (Technician)']
      summary: '(L3.1) Xem tồn kho tại trạm'
      description: Lấy danh sách tất cả phụ tùng và số lượng tồn kho tại trạm của KTV.
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/InventoryItemView' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /technician/inventory/search:
    get:
      tags: ['[3] Luồng Kỹ thuật viên (Technician)']
      summary: '(L3.2) Tìm phụ tùng trong kho bằng SKU'
      parameters:
        - name: sku
          in: query
          required: true
          schema: { type: string }
          description: "Mã SKU của phụ tùng (ví dụ: VIN-TYRE-001)"
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { $ref: '#/components/schemas/InventoryItemView' } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /technician/my-tasks:
    get:
      tags: ['[3] Luồng Kỹ thuật viên (Technician)']
      summary: '(L3.3) Lấy danh sách công việc CẦN LÀM'
      description: Lấy các công việc đang ở trạng thái PENDING (chờ nhận) hoặc IN_PROGRESS (đang làm).
      parameters:
        - name: status
          in: query
          required: false
          description: "Lọc theo trạng thái. (Mặc định là PENDING, IN_PROGRESS)."
          schema:
            $ref: '#/components/schemas/ServiceRecordStatusEnum_Pending_InProgress'
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/TechnicianTaskSummary' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /technician/completed-tasks:
    get:
      tags: ['[3] Luồng Kỹ thuật viên (Technician)']
      summary: '(L3.4) Lấy danh sách công việc ĐÃ HOÀN THÀNH'
      description: Lấy các công việc đã ở trạng thái COMPLETED (để xem lại lịch sử, thống kê).
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/TechnicianTaskSummary' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /technician/service-records/{id}/accept:
    put:
      tags: ['[3] Luồng Kỹ thuật viên (Technician)']
      summary: '(L3.5) Chấp nhận công việc (PENDING -> IN_PROGRESS)'
      description: KTV xác nhận bắt đầu thực hiện công việc (ServiceRecord).
      parameters: [{ $ref: '#/components/parameters/ServiceRecordIdPath' }]
      responses:
        '200': { description: Chấp nhận thành công., content: { application/json: { schema: { $ref: '#/components/schemas/ServiceRecord' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /technician/service-records/{id}/use-parts:
    post:
      tags: ['[3] Luồng Kỹ thuật viên (Technician)']
      summary: '(L3.6) Sử dụng phụ tùng (Trừ kho trực tiếp)'
      description: KTV báo cáo phụ tùng đã sử dụng. Hệ thống sẽ tự động trừ kho và thêm vào chi phí.
      parameters: [{ $ref: '#/components/parameters/ServiceRecordIdPath' }]
      requestBody: { $ref: '#/components/requestBodies/UsePartsInput' }
      responses:
        '200': { description: Phụ tùng đã được ghi nhận và trừ kho., content: { application/json: { schema: { $ref: '#/components/schemas/ServiceRecord' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /technician/service-records/{id}/complete:
    put:
      tags: ['[3] Luồng Kỹ thuật viên (Technician)']
      summary: '(L3.7) Hoàn thành công việc (IN_PROGRESS -> COMPLETED)'
      parameters: [{ $ref: '#/components/parameters/ServiceRecordIdPath' }]
      requestBody: { $ref: '#/components/requestBodies/CompletionInput' }
      responses:
        '200': { description: Hoàn thành thành công., content: { application/json: { schema: { properties: { message: { type: string }, data: { properties: { serviceRecord: { $ref: '#/components/schemas/ServiceRecord' }, appointment: { $ref: '#/components/schemas/ServiceAppointment' } } } } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  # ===============================================
  # === [4] LUỒNG QUẢN LÝ KHO (INVENTORY)
  # ===============================================
  /inventory/items:
    get:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.1) Xem tồn kho tại trạm (IM, SA, KTV)'
      description: (Roles: INVENTORY_MANAGER, STATION_ADMIN, TECHNICIAN)
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/InventoryItemView' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  
  /inventory/items/create: # (SỬA) Cập nhật đường dẫn
    post:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.2) Thêm mặt hàng mới vào kho (Định nghĩa Part & Kho)'
      description: (Roles: INVENTORY_MANAGER, STATION_ADMIN) Cung cấp SKU, Tên, Giá, v.v. để tạo Phụ tùng (Part) và Mục kho (InventoryItem) tại trạm.
      requestBody: { $ref: '#/components/requestBodies/AddInventoryItemInput' }
      responses:
        '201': { description: Thêm thành công., content: { application/json: { schema: { $ref: '#/components/schemas/InventoryItem' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  
  /inventory/items/search:
    get:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.1b) Tìm phụ tùng trong kho bằng SKU'
      description: (Roles: INVENTORY_MANAGER, STATION_ADMIN, TECHNICIAN)
      parameters:
        - name: sku
          in: query
          required: true
          schema: { type: string }
          description: "Mã SKU của phụ tùng (ví dụ: VIN-TYRE-001)"
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { $ref: '#/components/schemas/InventoryItemView' } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  
  /inventory/items/low-stock:
    get:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.3) Cảnh báo sắp hết hàng'
      description: (Roles: INVENTORY_MANAGER, STATION_ADMIN) Liệt kê các mặt hàng có số lượng <= mức tối thiểu.
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/InventoryItemView' } } } } }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  
  /inventory/items/{id}:
    get:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.4) Xem chi tiết 1 mặt hàng trong kho'
      description: (Roles: INVENTORY_MANAGER, STATION_ADMIN, TECHNICIAN)
      parameters: [{ $ref: '#/components/parameters/InventoryItemIdPath' }]
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { $ref: '#/components/schemas/InventoryItemView' } } } }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  
  /inventory/items/{id}/update: # (SỬA) Cập nhật đường dẫn
    put:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.5) Cập nhật thông tin/cấu hình kho'
      description: (Roles: INVENTORY_MANAGER) Cập nhật Tên, SKU, Giá, Mô tả, và minStockLevel. Không cập nhật số lượng tồn kho.
      parameters: [{ $ref: '#/components/parameters/InventoryItemIdPath' }]
      requestBody: { $ref: '#/components/requestBodies/UpdateInventoryItemInput' }
      responses:
        '200': { description: Cập nhật thành công., content: { application/json: { schema: { $ref: '#/components/schemas/InventoryItem' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  
  /inventory/items/{id}/remove: # (SỬA) Cập nhật đường dẫn
    delete:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.6) Xóa mềm mặt hàng khỏi kho'
      description: (Roles: STATION_ADMIN) Chỉ Station Admin mới được xóa (và chỉ khi tồn kho = 0).
      parameters: [{ $ref: '#/components/parameters/InventoryItemIdPath' }]
      responses:
        '204': { description: Xóa thành công. }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /inventory/restock-requests:
    post:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.7) Tạo Y/C nhập hàng (gửi cho Station Admin duyệt)'
      description: (Roles: INVENTORY_MANAGER) Nhân viên kho tạo yêu cầu nhập thêm hàng.
      requestBody: { $ref: '#/components/requestBodies/CreateRestockInput' }
      responses:
        '201': { description: Tạo Y/C thành công., content: { application/json: { schema: { $ref: '#/components/schemas/RestockRequest' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
    get:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.8) Xem lịch sử yêu cầu nhập hàng (của trạm mình)'
      description: (Roles: INVENTORY_MANAGER, STATION_ADMIN) Xem danh sách các yêu cầu đã tạo và trạng thái của chúng.
      parameters:
        - name: status
          in: query
          required: false
          schema: { $ref: '#/components/schemas/RestockRequestStatusEnum' }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/RestockRequestView' } } } } }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /inventory/restock-requests/{requestId}/import:
    post:
      tags: ['[4] Luồng Quản lý Kho (Inventory)']
      summary: '(L4.9) Xác nhận nhập kho (APPROVED -> COMPLETED)'
      description: (Roles: INVENTORY_MANAGER) Nhân viên kho xác nhận hàng đã về kho (sau khi Station Admin đã duyệt). Hành động này sẽ tăng số lượng tồn kho.
      parameters:
        - name: requestId
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        description: "Thông tin nhập kho (nếu cần)"
        content:
          application/json:
            schema:
              type: object
              properties: {} 
      responses:
        '200': { description: Nhập kho thành công., content: { application/json: { schema: { $ref: '#/components/schemas/RestockRequest' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  # ===============================================
  # === [5] LUỒNG QUẢN TRỊ VIÊN (ADMIN)
  # ===============================================
  /auth/all-profile:
    get:
      tags: ['[5] Luồng Quản trị viên (Admin)']
      summary: (Admin) Lấy danh sách TẤT CẢ tài khoản
      description: Lấy danh sách tất cả người dùng trong hệ thống (Customer, Staff, Admin...). Roles: ADMIN
      responses:
        '200': { description: Danh sách tất cả người dùng., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/User' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  # ===============================================
  # === [6] LUỒNG QUẢN LÝ TRẠM (STATION)
  # ===============================================
  /auth/create-account:
    post:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: (Station Admin) Tạo tài khoản nhân viên mới
      description: Trưởng trạm (Station Admin) tạo tài khoản cho nhân viên (Staff, Tech, IM) tại trạm của mình.
      requestBody: { $ref: '#/components/requestBodies/CreateAccountInput' }
      responses:
        '201': { description: Tạo tài khoản thành công., content: { application/json: { schema: { $ref: '#/components/schemas/CreateAccountResponse' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /station/stations/{stationId}/staff:
    get:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: '(L6.1) Lấy danh sách nhân viên tại trạm (ListStationStaff)'
      parameters:
        - { $ref: '#/components/parameters/StationIdPath' }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/User' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /station/stations/{stationId}/staff/{staffId}/status:
    put:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: '(L6.2) Cập nhật trạng thái nhân viên (UpdateStaffStatus)'
      parameters:
        - { $ref: '#/components/parameters/StationIdPath' }
        - { $ref: '#/components/parameters/StaffIdPath' }
      requestBody: { $ref: '#/components/requestBodies/UpdateStaffStatusInput' }
      responses:
        '200': { description: Cập nhật thành công., content: { application/json: { schema: { $ref: '#/components/schemas/User' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /station/certifications:
    get:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: '(L6.3) Lấy danh sách tất cả chứng chỉ (ListAllCertifications)'
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/Certification' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
  /station/technicians/{technicianId}/certifications:
    post:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: '(L6.4) Gán chứng chỉ cho KTV (AssignCertification)'
      parameters:
        - { $ref: '#/components/parameters/TechnicianIdPath' }
      requestBody: { $ref: '#/components/requestBodies/AssignCertificationInput' }
      responses:
        '201': { description: Gán thành công., content: { application/json: { schema: { $ref: '#/components/schemas/TechnicianCertification' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
        '409': { description: "Lỗi trùng lặp (KTV đã có chứng chỉ này)" }
  /station/technicians/{technicianId}/certifications/{certificationId}:
    delete:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: '(L6.5) Thu hồi chứng chỉ của KTV (RevokeCertification)'
      parameters:
        - { $ref: '#/components/parameters/TechnicianIdPath' }
        - { $ref: '#/components/parameters/CertificationIdPath' }
      responses:
        '200': { description: Thu hồi thành công., content: { application/json: { schema: { properties: { message: { type: string } } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /station/stations/{stationId}/technicians/{technicianId}/specialization:
    put:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: '(L6.6) Cập nhật chuyên môn KTV (UpdateTechnicianSpecification)'
      parameters:
        - { $ref: '#/components/parameters/StationIdPath' }
        - { $ref: '#/components/parameters/TechnicianIdPath' }
      requestBody: { $ref: '#/components/requestBodies/UpdateSpecificationInput' }
      responses:
        '200': { description: Cập nhật thành công., content: { application/json: { schema: { $ref: '#/components/schemas/TechnicianProfile' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /station/stations/{stationId}/reports/revenue:
    get:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: '(L6.7) Báo cáo doanh thu (GenerateStationRevenueReport)'
      parameters:
        - { $ref: '#/components/parameters/StationIdPath' }
        - { $ref: '#/components/parameters/DateFromQuery' }
        - { $ref: '#/components/parameters/DateToQuery' }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { $ref: '#/components/schemas/RevenueReport' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /station/stations/{stationId}/reports/technician-performance:
    get:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: '(L6.8) Báo cáo hiệu suất KTV (GenerateTechnicianPerformanceReport)'
      parameters:
        - { $ref: '#/components/parameters/StationIdPath' }
        - { $ref: '#/components/parameters/DateFromQuery' }
        - { $ref: '#/components/parameters/DateToQuery' }
      responses:
        '200': { description: Thành công., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/TechnicianPerformanceReport' } } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /inventory/restock-requests:
    get:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: (L6.9) [Trưởng trạm] Xem Y/C nhập hàng
      description: Trưởng trạm (Station Admin) xem các yêu cầu nhập hàng tại trạm của mình (do IM tạo).
      parameters:
        - name: status
          in: query
          required: false
          schema: { $ref: '#/components/schemas/RestockRequestStatusEnum' }
      responses:
        '200': { description: Danh sách yêu cầu nhập hàng., content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/RestockRequestView' } } } } }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
  /inventory/restock-requests/{id}/approve:
    put:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: (L6.10) [Trưởng trạm] Duyệt Y/C nhập hàng
      description: Trưởng trạm (Station Admin) duyệt một yêu cầu nhập hàng (Restock Request) tại trạm của mình.
      parameters:
        - { $ref: '#/components/parameters/RestockRequestIdPath' }
      requestBody: { $ref: '#/components/requestBodies/ApproveRejectRestockInput' }
      responses:
        '200': { description: Đã duyệt thành công., content: { application/json: { schema: { $ref: '#/components/schemas/RestockRequest' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
  /inventory/restock-requests/{id}/reject:
    put:
      tags: ['[6] Luồng Quản lý Trạm (Station)']
      summary: (L6.11) [Trưởng trạm] Từ chối Y/C nhập hàng
      description: Trưởng trạm (Station Admin) từ chối một yêu cầu nhập hàng (Restock Request) tại trạm của mình.
      parameters:
        - { $ref: '#/components/parameters/RestockRequestIdPath' }
      requestBody: { $ref: '#/components/requestBodies/ApproveRejectRestockInput' }
      responses:
        '200': { description: Đã từ chối thành công., content: { application/json: { schema: { $ref: '#/components/schemas/RestockRequest' } } } }
        '400': { $ref: '#/components/responses/BadRequestError' }
        '401': { $ref: '#/components/responses/UnauthorizedError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '404': { $ref: '#/components/responses/NotFoundError' }
# ===============================================
# COMPONENTS
# ===============================================
components:
  # --- SCHEMAS ---
  schemas:
    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        employeeCode: { type: string, nullable: true, description: "Mã nhân viên (chỉ dành cho nhân viên)" }
        fullName: { type: string }
        email: { type: string, format: email }
        role: { $ref: '#/components/schemas/RoleEnum' }
        phoneNumber: { type: string, nullable: true }
        address: { type: string, nullable: true }
        serviceCenterId: { type: string, format: uuid, nullable: true }
        isActive: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    Vehicle:
      type: object
      properties:
        id: { type: string, format: uuid }
        vin: { type: string }
        year: { type: integer }
        licensePlate: { type: string, nullable: true }
        color: { type: string, nullable: true }
        ownerId: { type: string, format: uuid }
        currentMileage: { type: integer, nullable: true, default: 0 }
        isDeleted: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        vehicleModel: { $ref: '#/components/schemas/VehicleModel' }
        battery: { $ref: '#/components/schemas/BatteryType' }
    VehicleModel:
      type: object
      properties:
        id: { type: string, format: uuid }
        brand: { type: string, example: "VinFast" }
        name: { type: string, example: "VF8" }
    BatteryType:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string, example: "Pin LFP 90kWh (Thuê)" }
        capacityKwh: { type: number, format: float, example: 90 }
    ServiceType:
      type: object
      description: "Đại diện cho một Gói Dịch Vụ (ví dụ: Bảo dưỡng cơ bản)"
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        description: { type: string, nullable: true }
        price: { type: number, format: double, nullable: true, description: "Giá của gói dịch vụ" }
    ServiceCenter:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        address: { type: string }
        phoneNumber: { type: string, nullable: true }
        openingTime: { type: string, example: "08:00" }
        closingTime: { type: string, example: "17:00" }
        slotDurationMinutes: { type: integer }
        capacityPerSlot: { type: integer }
    AvailableSlot:
      type: object
      properties:
        time: { type: string, format: date-time }
        available: { type: boolean }
    ServiceAppointment:
      type: object
      properties:
        id: { type: string, format: uuid }
        appointmentDate: { type: string, format: date-time }
        status: { $ref: '#/components/schemas/AppointmentStatusEnum' }
        customerNotes: { type: string, nullable: true }
        customerId: { type: string, format: uuid }
        vehicleId: { type: string, format: uuid }
        serviceCenterId: { type: string, format: uuid }
        createdAt: { type: string, format: date-time }
    ServiceRecord:
      type: object
      properties:
        id: { type: string, format: uuid }
        appointmentId: { type: string, format: uuid }
        technicianId: { type: string, format: uuid }
        status: { $ref: '#/components/schemas/ServiceRecordStatusEnum', nullable: true }
        startTime: { type: string, format: date-time, nullable: true }
        endTime: { type: string, format: date-time, nullable: true }
        staffNotes: { type: string, nullable: true, description: "Ghi chú của KTV khi hoàn thành" }
    Part:
      type: object
      properties:
        id: { type: string, format: uuid }
        sku: { type: string }
        name: { type: string }
        description: { type: string, nullable: true }
        price: { type: number, format: double }
    InventoryItem:
      type: object
      properties:
        id: { type: string, format: uuid }
        quantityInStock: { type: integer }
        minStockLevel: { type: integer }
        partId: { type: string, format: uuid }
        serviceCenterId: { type: string, format: uuid }
    InventoryItemView:
      allOf:
        - { $ref: '#/components/schemas/InventoryItem' }
        - type: object
          properties:
            part: { $ref: '#/components/schemas/Part' }
    PartUsage:
      type: object
      properties:
        id: { type: string, format: uuid }
        quantity: { type: integer }
        unitPrice: { type: number, format: double, description: "Giá tại thời điểm sử dụng" }
        status: { $ref: '#/components/schemas/PartUsageStatusEnum' }
        serviceRecordId: { type: string, format: uuid }
        partId: { type: string, format: uuid }
    Invoice:
      type: object
      properties:
        id: { type: string, format: uuid }
        serviceRecordId: { type: string, format: uuid }
        totalAmount: { type: number, format: double }
        status: { $ref: '#/components/schemas/InvoiceStatusEnum' }
        issueDate: { type: string, format: date-time }
        dueDate: { type: string, format: date-time }
    Payment:
      type: object
      properties:
        id: { type: string, format: uuid }
        invoiceId: { type: string, format: uuid }
        paymentMethod: { type: string }
        status: { $ref: '#/components/schemas/PaymentStatusEnum' }
        paymentDate: { type: string, format: date-time }
    RestockRequest:
      type: object
      properties:
        id: { type: string, format: uuid }
        quantity: { type: integer }
        notes: { type: string, nullable: true }
        status: { $ref: '#/components/schemas/RestockRequestStatusEnum' }
        createdAt: { type: string, format: date-time }
        processedAt: { type: string, format: date-time, nullable: true }
        partId: { type: string, format: uuid }
        inventoryManagerId: { type: string, format: uuid }
        serviceCenterId: { type: string, format: uuid }
        stationAdminId: { type: string, format: uuid, nullable: true }
        adminId: { type: string, format: uuid, nullable: true }
    Certification:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string, example: "Chứng chỉ sửa chữa điện VF E-Series" }
        description: { type: string, nullable: true }
    TechnicianCertification:
      type: object
      properties:
        staffId: { type: string, format: uuid }
        certificationId: { type: string, format: uuid }
        issueDate: { type: string, format: date-time }
    TechnicianProfile:
      type: object
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        specialization: { type: string, nullable: true, example: "Hệ thống pin, Động cơ điện" }
    RevenueReport:
      type: object
      properties:
        totalRevenue: { type: number, format: double }
        totalServices: { type: integer }
        totalPartsSold: { type: integer }
        fromDate: { type: string, format: date-time }
        toDate: { type: string, format: date-time }
    TechnicianPerformanceReport:
      type: object
      properties:
        technicianId: { type: string, format: uuid }
        technicianName: { type: string }
        totalTasksCompleted: { type: integer }
        averageRating: { type: number, format: double, nullable: true }
        revenueGenerated: { type: number, format: double }
    UserSummary:
      type: object
      properties:
        id: { type: string, format: uuid }
        fullName: { type: string }
        email: { type: string, format: email }
        role: { $ref: '#/components/schemas/RoleEnum' }
        employeeCode: { type: string, nullable: true }
    LoginResponse:
      type: object
      properties:
        message: { type: string }
        token: { type: string }
        user: { $ref: '#/components/schemas/User' }
    GoogleOAuthResponse:
      type: object
      properties:
        message: { type: string }
        token: { type: string }
        user: { $ref: '#/components/schemas/User' }
    CreateAccountResponse:
      type: object
      properties:
        user: { $ref: '#/components/schemas/UserSummary' }
        temporaryPassword: { type: string }
    TechnicianInfo:
      type: object
      properties:
        id: { type: string, format: uuid }
        fullName: { type: string }
        employeeCode: { type: string, nullable: true }
        email: { type: string, format: email }
    CustomerInfoSummary:
      type: object
      properties:
        fullName: { type: string }
        phoneNumber: { type: string, nullable: true }
    VehicleInfoSummary:
      type: object
      properties:
        brand: { type: string }
        model: { type: string }
        licensePlate: { type: string, nullable: true }
    AppointmentSummaryStaffView:
      type: object
      properties:
        id: { type: string, format: uuid }
        appointmentDate: { type: string, format: date-time }
        status: { $ref: '#/components/schemas/AppointmentStatusEnum' }
        customer: { $ref: '#/components/schemas/CustomerInfoSummary' }
        vehicle: { $ref: '#/components/schemas/VehicleInfoSummary' }
    AppointmentHistoryView:
      type: object
      properties:
        id: { type: string, format: uuid }
        appointmentDate: { type: string, format: date-time }
        status: { $ref: '#/components/schemas/AppointmentStatusEnum' }
        vehicle: { type: string, example: "VinFast VF8 (51K-123.45)" }
        serviceCenter: { type: string, example: "VinFast Service Quận 1" }
        serviceTitle: { type: string, example: "Bảo dưỡng định kỳ" }
    AppointmentDetailSharedView:
      allOf:
        - { $ref: '#/components/schemas/ServiceAppointment' }
        - type: object
          properties:
            customer: { $ref: '#/components/schemas/User' }
            vehicle: { $ref: '#/components/schemas/Vehicle' }
            serviceCenterName: { type: string, nullable: true }
            requestedServices:
              type: array
              items: { $ref: '#/components/schemas/ServiceType' }
            serviceRecord:
              type: object
              properties:
                id: { type: string, format: uuid }
                status: { $ref: '#/components/schemas/ServiceRecordStatusEnum' }
                staffNotes: { type: string, nullable: true }
                invoice: 
                  allOf:
                    - { $ref: '#/components/schemas/Invoice' }
                    - type: object
                      properties:
                        payments: # Đính kèm thanh toán
                          type: array
                          items: { $ref: '#/components/schemas/Payment' }
                partsUsed:
                  type: array
                  items:
                    allOf:
                      - { $ref: '#/components/schemas/PartUsage' }
                      - type: object
                        properties:
                          part: { $ref: '#/components/schemas/Part' }
    TechnicianTaskSummary:
      type: object
      properties:
        id: { type: string, format: uuid, description: "Đây là ID của ServiceRecord" }
        status: { $ref: '#/components/schemas/ServiceRecordStatusEnum', nullable: true }
        startTime: { type: string, format: date-time, nullable: true }
        appointment:
          type: object
          properties:
            id: { type: string, format: uuid }
            appointmentDate: { type: string, format: date-time }
            customer: { $ref: '#/components/schemas/CustomerInfoSummary' }
            vehicle: { $ref: '#/components/schemas/VehicleInfoSummary' }
            requestedServices: # Thêm gói dịch vụ
              type: array
              items:
                type: object
                properties:
                  serviceType:
                    type: object
                    properties:
                      name: { type: string }
    RestockRequestView:
      allOf:
        - { $ref: '#/components/schemas/RestockRequest' }
        - type: object
          properties:
            part: { $ref: '#/components/schemas/Part' }
            inventoryManager: { $ref: '#/components/schemas/UserSummary', nullable: true }
            admin: { $ref: '#/components/schemas/UserSummary', nullable: true }
    RestockRequestAdminView:
      allOf:
        - { $ref: '#/components/schemas/RestockRequest' }
        - type: object
          properties:
            part: { $ref: '#/components/schemas/Part' }
            serviceCenter: { $ref: '#/components/schemas/ServiceCenter' }
            inventoryManager: { $ref: '#/components/schemas/UserSummary' }
            admin: { $ref: '#/components/schemas/UserSummary', nullable: true }

    # --- ENUMS ---
    RoleEnum:
      type: string
      enum: [CUSTOMER, STAFF, TECHNICIAN, INVENTORY_MANAGER, ADMIN, STATION_ADMIN]
    AppointmentStatusEnum:
      type: string
      enum: [PENDING, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED]
    ServiceRecordStatusEnum:
      type: string
      enum: [PENDING, IN_PROGRESS, COMPLETED, CANCELLED]
    # (THÊM MỚI) Enum con chỉ dành cho KTV
    ServiceRecordStatusEnum_Pending_InProgress:
      type: string
      enum: [PENDING, IN_PROGRESS]
    InvoiceStatusEnum:
      type: string
      enum: [UNPAID, PAID, OVERDUE]
    PaymentStatusEnum:
      type: string
      enum: [PENDING, SUCCESSFUL, FAILED]
    PartUsageStatusEnum:
      type: string
      enum: [ISSUED, CANCELLED]
    RestockRequestStatusEnum:
      type: string
      enum: [PENDING, APPROVED, REJECTED, COMPLETED]
    ErrorResponse:
      type: object
      properties:
        message: { type: string }

  # --- REQUEST BODIES ---
  requestBodies:
    RegisterInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [fullName, email, password, confirmPassword]
            properties:
              fullName: { type: string }
              email: { type: string, format: email }
              password: { type: string, format: password, minLength: 5 }
              confirmPassword: { type: string, format: password }
              phoneNumber: { type: string, nullable: true }
    LoginInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [email, password]
            properties:
              email: { type: string, format: email }
              password: { type: string, format: password }
    ForgotPasswordInput:
      required: true
      content: { application/json: { schema: { type: object, required: [email], properties: { email: { type: string, format: email } } } } }
    VerifyCodeInput:
      required: true
      content: { application/json: { schema: { type: object, required: [email, resetCode], properties: { email: { type: string, format: email }, resetCode: { type: string } } } } }
    ResetPasswordInput:
      required: true
      content: { application/json: { schema: { type: object, required: [newPassword, confirmPassword], properties: { newPassword: { type: string, format: password, minLength: 5 }, confirmPassword: { type: string, format: password } } } } }
    UpdateProfileInput:
      required: true
      content: { application/json: { schema: { type: object, properties: { fullName: { type: string }, phoneNumber: { type: string }, address: { type: string } } } } }
    ChangePasswordInput:
      required: true
      content: { application/json: { schema: { type: object, required: [oldPassword, newPassword], properties: { oldPassword: { type: string, format: password }, newPassword: { type: string, format: password, minLength: 5 } } } } }
    CreateAccountInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [fullName, email, role]
            properties:
              fullName: { type: string }
              email: { type: string, format: email }
              role: { $ref: '#/components/schemas/RoleEnum' }
              serviceCenterId: { type: string, format: uuid, nullable: true }
    CreateCustomerInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [fullName, phoneNumber]
            properties:
              fullName: { type: string }
              phoneNumber: { type: string }
              email: { type: string, format: email, nullable: true }
    CreateVehicleInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [vin, year, vehicleModelId, batteryId]
            properties:
              vin: { type: string, example: "VINFASTVF8XYZ123" }
              year: { type: integer, example: 2024 }
              vehicleModelId: { type: string, format: uuid, description: "Lấy từ GET /vehicle/models" }
              batteryId: { type: string, format: uuid, description: "Lấy từ GET /vehicle/models/{modelId}/batteries" }
              licensePlate: { type: string, example: "51K-123.45", nullable: true }
              color: { type: string, example: "Đen", nullable: true }
              currentMileage: { type: integer, example: 15000, default: 0, nullable: true }
    UpdateVehicleInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            description: "Chỉ gửi các trường muốn cập nhật."
            properties:
              licensePlate: { type: string, nullable: true }
              color: { type: string, nullable: true }
              batteryId: { type: string, format: uuid, nullable: true, description: "Phải là Pin tương thích" }
              currentMileage: { type: integer, nullable: true, description: "Số km mới nhất" }
    AppointmentInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [vehicleId, serviceCenterId, appointmentDate, servicePackageId]
            properties:
              vehicleId: { type: string, format: uuid }
              serviceCenterId: { type: string, format: uuid }
              appointmentDate: { type: string, format: date-time }
              customerNotes: { type: string, nullable: true }
              servicePackageId: { type: string, format: uuid, description: "ID của Gói dịch vụ (ServiceType) được chọn." }
    WalkInAppointmentInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [customerId, vehicleId, appointmentDate, servicePackageId, technicianId]
            properties:
              customerId: { type: string, format: uuid }
              vehicleId: { type: string, format: uuid }
              appointmentDate: { type: string, format: date-time }
              servicePackageId: { type: string, format: uuid, description: "ID của Gói dịch vụ (ServiceType) được chọn." }
              technicianId: { type: string, format: uuid }
              customerNotes: { type: string, nullable: true }
    ConfirmAppointmentInput:
      required: true
      content: { application/json: { schema: { type: object, required: [technicianId], properties: { technicianId: { type: string, format: uuid } } } } }
    UsePartsInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [partItems]
            properties:
              partItems:
                type: array
                description: "Danh sách phụ tùng KTV đã sử dụng"
                items:
                  type: object
                  properties:
                    partId: { type: string, format: uuid }
                    quantity: { type: integer, minimum: 1 }
    CompletionInput:
      required: false
      content:
        application/json:
          schema:
            type: object
            properties:
              notes: { type: string, nullable: true, description: "Ghi chú của KTV khi hoàn thành" }
    AddInventoryItemInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [sku, name, price, minStockLevel]
            properties:
              sku: { type: string, example: "VIN-PART-NEW" }
              name: { type: string, example: "Phụ tùng mới" }
              description: { type: string, nullable: true }
              price: { type: number, format: double, minimum: 1, example: 100000 }
              minStockLevel: { type: integer, minimum: 1, example: 5 }
    UpdateInventoryItemInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            description: "Gửi bất kỳ trường nào bạn muốn cập nhật. Số lượng (quantityInStock) không được phép cập nhật tại đây."
            properties:
              sku: { type: string, example: "VIN-PART-NEW" }
              name: { type: string, example: "Tên phụ tùng mới" }
              description: { type: string, nullable: true }
              price: { type: number, format: double, minimum: 1 }
              minStockLevel: { type: integer, minimum: 1 }
    CreateRestockInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [partId, quantity]
            properties:
              partId: { type: string, format: uuid, description: "ID của phụ tùng (Part)" }
              quantity: { type: integer, minimum: 1 }
              notes: { type: string, nullable: true }
    ApproveRejectRestockInput:
      required: false
      content:
        application/json:
          schema:
            type: object
            properties:
              notes: { type: string, nullable: true, description: "Ghi chú lý do từ chối/duyệt" }
    UpdateStaffStatusInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [isActive]
            properties:
              isActive: { type: boolean }
    AssignCertificationInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [certificationId, certificateNumber]
            properties:
              certificationId: { type: string, format: uuid }
              certificateNumber: { type: string }
    UpdateSpecificationInput:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [specialization]
            properties:
              specialization: { type: string }

  # --- RESPONSES (Common Errors) ---
  responses:
    BadRequestError:
      description: Bad Request - Dữ liệu không hợp lệ hoặc thiếu.
      content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } }
    UnauthorizedError:
      description: Unauthorized - Chưa đăng nhập hoặc token không hợp lệ/hết hạn.
      content: { application/json: { schema: { properties: { message: { type: string } } } } }
    ForbiddenError:
      description: Forbidden - Không có quyền truy cập tài nguyên hoặc thực hiện hành động.
      content: { application/json: { schema: { properties: { message: { type: string } } } } }
    NotFoundError:
      description: Not Found - Không tìm thấy tài nguyên được yêu cầu.
      content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } }

  # --- PARAMETERS ---
  parameters:
    AppointmentIdPath:
      name: id
      in: path
      required: true
      description: ID Lịch hẹn (Appointment)
      schema: { type: string, format: uuid }
    ServiceCenterIdPath:
      name: id
      in: path
      required: true
      description: ID Trung tâm (Service Center)
      schema: { type: string, format: uuid }
    ServiceRecordIdPath:
      name: id
      in: path
      required: true
      description: ID Bản ghi dịch vụ (Service Record)
      schema: { type: string, format: uuid }
    InvoiceIdPath:
      name: id
      in: path
      required: true
      description: ID Hóa đơn (Invoice)
      schema: { type: string, format: uuid }
    CustomerIdPath:
      name: customerId
      in: path
      required: true
      description: ID Khách hàng (Customer)
      schema: { type: string, format: uuid }
    InventoryItemIdPath:
      name: id
      in: path
      required: true
      description: ID Kho (Inventory Item)
      schema: { type: string, format: uuid }
    RestockRequestIdPath:
      name: id
      in: path
      required: true
      description: ID Yêu cầu nhập hàng (Restock Request)
      schema: { type: string, format: uuid }
    DateQuery:
      name: date
      in: query
      required: true
      description: Ngày (YYYY-MM-DD)
      schema: { type: string, format: date }
    ResetTokenHeader:
      name: Authorization
      in: header
      required: true
      description: "Token tạm thời để reset password. Ví dụ: 'Bearer {resetToken}'"
      schema: { type: string }
    VehicleIdPath:
      name: id
      in: path
      required: true
      description: ID của Xe (Vehicle)
      schema: { type: string, format: uuid }
    VehicleModelIdPath:
      name: modelId
      in: path
      required: true
      description: ID của Dòng xe (Vehicle Model)
      schema: { type: string, format: uuid }
    StationIdPath:
      name: stationId
      in: path
      required: true
      description: ID Trạm (Station / Service Center)
      schema: { type: string, format: uuid }
    StaffIdPath:
      name: staffId
      in: path
      required: true
      description: ID Nhân viên (Staff)
      schema: { type: string, format: uuid }
    TechnicianIdPath:
      name: technicianId
      in: path
      required: true
      description: ID Kỹ thuật viên (Technician / Staff)
      schema: { type: string, format: uuid }
    CertificationIdPath:
      name: certificationId
      in: path
      required: true
      description: ID Chứng chỉ (Certification)
      schema: { type: string, format: uuid }
    DateFromQuery:
      name: fromDate
      in: query
      required: true
      description: Ngày bắt đầu (YYYY-MM-DD)
      schema: { type: string, format: date }
    DateToQuery:
      name: toDate
      in: query
      required: true
      description: Ngày kết thúc (YYYY-MM-DD)
      schema: { type: string, format: date }

  # --- SECURITY ---
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "Nhập JWT token. Ví dụ: 'Bearer {token}'"